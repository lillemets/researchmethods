title: Analysis of variance
subtitle: Research methods
author: JÃ¼ri Lillemets
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console

``` {r setup, include = F}
# Settings
knitr::opts_chunk$set(echo = F, warning = F, dpi = 150, fig.height = 4)
# Load packages
library('magrittr');library('knitr')
# Set colors
Col <- c(red = '#e6457a', green = '#b0e645', blue = '#45cbe6')
```

class: center middle clean

# Are differences between groups higher than within groups?

---

class: center middle inverse

# Hypothesis testing as a model

---

We can specify relationship as a model:

$$Y_{ij}=\mu+\varepsilon_{ij},$$ 

where 

- $Y$ is the value for observation $i$ from group $j$, 
- $\mu$ the overall mean, and 
- $\varepsilon_{ij}$ the difference between overall mean $\mu$ and value for observation $i$ from factor $j$.

---

We can also separate factor $\alpha$ from other variables:

$$Y_{ij}=\mu+\alpha_{j}+\varepsilon_{ij},$$

- $Y$ is the value for observation $i$ from group $j$, 
- $\mu$ the overall mean, 
- $\alpha_{i}$ the difference between mean of group $j$ and overall mean $\mu$, and 
- $\varepsilon_{ij}$ the difference between group mean and value for observation $i$ from factor $j$.

---

$$Y_{ij}=\mu+\alpha_{j}+\varepsilon_{ij},$$


```{r}
mkPlot <- function() {
  plot(yield ~ jitter(as.numeric(loc)), sorg, xaxt = 'n', xlim = c(.5,3.5), 
       xlab = "Location", ylab = "Yield")
  axis(1, at = 1:3, labels = levels(sorg$loc))
  points(tapply(sorg$yield, sorg$loc, mean), pch = '_', cex = 3, col = 'tomato')
  abline(h = mean(sorg$yield), col = 'tomato', lwd = 2, lty = 'dashed')
  legend('topright', 
         c("Group means", "Overall mean"), 
         col = c('tomato'), 
         lty = c('solid', 'dashed'))
}
mkPlot()
points(c(NA, sorg$yield[1], NA), bg =  'tomato', pch = 21, cex = 2)
```

---

```{r}
sorg$yield[1]
mu <- mean(sorg$yield)
alpha <- mean(sorg$yield[sorg$loc == 'Melkassa']) - mean(sorg$yield)
epsilon <- sorg$yield[1] - mean(sorg$yield[sorg$loc == 'Melkassa'])
mu + alpha + epsilon
```

---

There are two sources of variation: 

- random variation within a group, i.e. $\varepsilon_{ij}$
- variation between groups, i.e. $\alpha_{j}$

The idea behind Anova is comparing these. If the variation between groups is higher that variation within groups by a certain degree, we can say that there's an effect.

---

class: center middle inverse

# Comparing sources of variation

---

## One way Anova

Assumptions:

- normality
- independence
- homogeneity of variance (only for Welch's test)

---

Example data

Multi-environment trial of sorghum at 3 locations across 5 years. We'll assume that the data isbase on random samples.

```{r}
sorg <- agridat::adugna.sorghum
sorg <- sorg[sorg$year == 2004, ]
head(sorg)
```

---

### Hypotheses

Are mean values equal? 

$H_0: \bar{x}_1 = \bar{x}_2 = \bar{x}_3$  
$H_1: \bar{x}_1 = \bar{x}_2 \neq \bar{x}_3 \or \bar{x}_1 \neq \bar{x}_2 \neq \bar{x}_3$

Is mean yield different among locations? Does location have an effect on yield?

```{r, echo = F}
boxplot(yield ~ loc, sorg)
points(tapply(sorg$yield, sorg$loc, mean), pch = '_', cex = 3, col = 'tomato')
```

Let's set significance level $\alpha = 0.05$. 

---

### Test statistic $F$

Test statistic $F$ is calculated as 

$F = MSA / MSE,$

where $MSA$ expresses variation between group and $MSE$ represents random variaton. In order to understand what this means let's start from the initial measures, the sum of squares of variable $y$ for observations $i$ in groups $j$:

- within-group sum of squares, i.e. sum of squares of errors (SSE)  
  $SSE=\sum_{j=1}^{k}\sum_{i=1}^{n} (y_{ij}-\overline{y_{j}})^{2}$, $df = n-k$
- between group sum of squares, i.e. sum of squares between groups (SSA)  
  $SSA=\sum_{j=1}^{k}\sum_{i=1}^{n_{j}} (\overline{y_{j}}-\overline{y})^{2}$, $df = k - 1$
- total sum of squares (SST=SSE+SSA)  
  $SST=\sum_{j=1}^{k}\sum_{i=1}^{n} (y_{ij}-\overline{y})^{2}$, $df = n-1$

We can use these variations to find $MSA$ and $MSE$ as follows:

- mean squares for SSE (MSE)
  $MSE = SSE / (n - k)$
- mean squares for SSA (MSA)
  $MSA = SSA / (k - 1)$

---

```{r}
mkPlot <- function() {
  plot(yield ~ jitter(as.numeric(loc)), sorg, xaxt = 'n', xlim = c(.5,3.5), 
       xlab = "Location", ylab = "Yield")
  axis(1, at = 1:3, labels = levels(sorg$loc))
  points(tapply(sorg$yield, sorg$loc, mean), pch = '_', cex = 3, col = 'tomato')
  abline(h = mean(sorg$yield), col = 'tomato', lwd = 2, lty = 'dashed')
  legend('topright', 
         c("Group means", "Overall mean"), 
         col = c('tomato'), 
         lty = c('solid', 'dashed'))
}
mkPlot()
points(c(NA, sorg$yield[1], NA), bg =  'tomato', pch = 21, cex = 2)
```

---

### Test statistic $F$ on F-distribution

``` {r}
Test <- t.test(iris$Petal.Length[iris$Species == 'versicolor'], iris$Petal.Length[iris$Species == 'virginica'], var.equal = T)
```

Value of test statistic is `r Test$statistic %>% round(3)`. Test statistic is evaluated on t-distribution with $n_1+n_2-2$ df.

``` {r}
par(bty = 'n', yaxt = 'n', family = 'RobotoCondensed')
curve(dt(x, nrow(iris)+nrow(iris)-2), -3, 3, 
      main = "T-distribution (df = 30)", xlab = "Test statistic", ylab = "Density")
abline(v = c(-Test$statistic, Test$statistic), col = Col['red']) # Empirical
abline(v = c(-1.97, 1.97), col = Col['blue']) # Critical
```

---

P-value is `r Test$p.value %>% round(3)` and we chose significance level to be $\alpha = 0.05$.

> Do these petal samples come from the same population?

---

## Independent samples t-test assuming equal variances

Assumptions:

- normality
- independence
- homogeneity of variance  
  $\frac{1}{2} < \frac{s_1}{s_2}<2$  

---

Example data from "Edgar Anderson's Iris Data" dataset.

```` {r}
makePlot <- function() {
  par(mar = c(4,0,0,0), bty = 'n', yaxt = 'n', family = 'RobotoCondensed')
  plot(density(iris$Petal.Length), type = 'n', 
       main = NA, xlab = 'Petal length, cm', ylab = '', 
       ylim = c(0,1))
  lines(density(iris$Petal.Length[iris$Species == 'versicolor']), col = Col['red'])
  lines(density(iris$Petal.Length[iris$Species == 'virginica']), col = Col['blue'])
}
makePlot()
abline(v = mean(iris$Petal.Length[iris$Species == 'versicolor']), col = Col['red'])
abline(v = mean(iris$Petal.Length[iris$Species == 'virginica']), col = Col['blue'])
````

In this case $\frac{s_1}{s_2} =$ `r var(iris$Petal.Length[iris$Species == 'virginica'])/ var(iris$Petal.Length[iris$Species == 'versicolor'])`.

---

### Hypotheses

Are the mean values equal? Do these samples come from the same population?

$H_0: \bar{x}_1 = \bar{x}_2$  
$H_1: \bar{x}_1 \neq \bar{x}_2$

Let's set significance level $\alpha = 0.05$. 

---

### Test statistic $t$

Test statistic $F$ is calculated as 

$F = MSA / MSE,$

where $MSA$ expresses variation between group and $MSE$ represents random variaton. In order to understand what this means let's start from the initial measures, the sum of squares of variable $y$ for observations $i$ in groups $j$:

- within-group sum of squares, i.e. sum of squares of errors (SSE)  
  $SSE=\sum_{j=1}^{k}\sum_{i=1}^{n} (y_{ij}-\overline{y_{j}})^{2}$, $df = n-k$
- between group sum of squares, i.e. sum of squares between groups (SSA)  
  $SSA=\sum_{j=1}^{k}\sum_{i=1}^{n_{j}} (\overline{y_{j}}-\overline{y})^{2}$, $df = k - 1$
- total sum of squares (SST=SSE+SSA)  
  $SST=\sum_{j=1}^{k}\sum_{i=1}^{n} (y_{ij}-\overline{y})^{2}$, $df = n-1$

We can use these variations to find $MSA$ and $MSE$ as follows:

- mean squares for SSE (MSE)
  $MSE = SSE / (n - k)$
- mean squares for SSA (MSA)
  $MSA = SSA / (k - 1)$

---

### Test statistic $t$ on t-distribution

``` {r}
#Test <- t.test(iris$Petal.Length[iris$Species == 'versicolor'], #iris$Petal.Length[iris$Species == 'virginica'], var.equal = T)
```

Value of test statistic is `r Test$statistic %>% round(3)`. Test statistic is evaluated on F-distribution with $...$ df.

``` {r, fig.height = 5}
curve(df(x, df1 = av[[1]]['Df'][1, ], df2 = av[[1]]['Df'][2, ]), 1, 40)
abline(v = av[[1]]['F value'][1,1], col = 'tomato')
```

---

P-value is `r Test$p.value %>% round(3)` and we chose significance level to be $\alpha = 0.05$.

> Do these petal samples come from the same population?

???
Different species: versicolor and virginica.

---

class: center middle inverse

# So which groups exactly are different?

---

Post-hoc tests. Tukey's honest significant differences